# [설문] 도메인을 구현하기 위한 ERD 와 JPA mapping 정의  (1)
https://s2ujeong.tistory.com/7


요즘 저는 abcdedu 라는 교육 플랫폼 웹 서비스를 개발하며 정신 없는 나날을 보내고 있습니다.

여느 기능 보다 수업을 듣고 나서 남기는 설문 기능을 구현하며 많은 고민을 했습니다. 특히 DB와 관련된 부분을 이야기하고자 합니다.

## 1. 설문 기능은 어떻게 구성될까요?

설문 기능은 설문, 질문, 질문의 선택지, 응답으로 이루어진 거대한 개념이라고 생각했습니다.

각 기능을 분리해서 생각하여 테이블 또한 각각 구성하기로 했습니다.

개별적으로 설계함으로써 관리자가 언제든 설문에 대한 내용을 유연하게 수정할 수 있도록 각각의 기능을 분리하고자 했습니다.

1. '2024 강의 만족도 조사' 라는 하나의 `설문`을 만듭니다.
2. 각 `질문`을 만듭니다. 이때 질문은 설문에 속하지 않아 다른 설문에서 같은 질문을 할 때 재활용할 수 있습니다.
    -  예를 들어 "귀하의 소중한 의견을 자유롭게 주세요 :-)" 같은 질문은 어떤 설문에서든지 재활용하면 좋을 것 입니다.

3.  각 질문을 만들며, 객관식으로 주어질 질문은 선택지 또한 만들어 줍니다.
- 질문과 선택지는 연관관계가 높으므로 질문과 묶어 재활용할 수 있게 하며 선택지 독립적으로는 재활용 하기 어려울 것 입니다.

4. 응답자는 설문에 속한 모든 질문에 대해 응답을 생성합니다.



## 2. DB 설계는 어떻게 했나요?



![image-20240916035455664](https://raw.githubusercontent.com/sj9802/images/main/img/image-20240916035455664.png)

저 파란색 연결선과 분홍색 연결선이 보이시나요?

이 색상 차이는 테이블의 식별/비식별 관계를 의미합니다. 저의 첫번째 고민점입니다.



### 식별/비식별 관계

이론적으로 생각해봅니다.

- 식별 관계
    - 테이블의 기본키 or 유니크키가 연관 테이블의 기본키로 사용되는 관계
    - 연관 테이블의 키가 자신의 기본키에 포함되기 때문에 연관 테이블에 데이터가 존재해야 해당 테이블에 데이터를 생성할 수 있습니다.

- 비식별 관계
    - 연관 테이블의 기본키 or 유니크키를 외래 키로 사용하는 관계
    - 연관 테이블에 데이터에 상관 없이 독립적으로 생성할 수 있습니다.



이렇게 이론적으로만 생각하니 어떤 관계를 사용해야 할 지 어떤 장점이 있는건지 알 수 없었습니다.

그래서 실무를 생각하며 영향을 미치는 부분에 대해 알아보았습니다.

결론부터 말하자면 성능 최적화가 중요한 시스템 (분산 아키텍처, 로그 데이터 관리) 에선 비식별 관계 사용을 지향하며 마이크로 서비스 환경에서도 비식별 관계가 일반적이라고 합니다. (from Chat GPT)

하지만 관계형 데이터베이스를 사용하는 환경에서는 데이터 무결성 보장을 위해 식별관계를 사용하길 권장하고 있습니다.

그렇다면 식별/비식별 관계를 지정하는 것이 왜 성능과 데이터 무결성 보장과 관련 되는걸까요?



### 성능, 데이터 무결성, 확장성을 고려한 테이블 관계

식별 관계는 연관 관계에 있는 테이블의 기본 키를 외래키로 가져와 연관 반대편의 테이블의 기본키로 등록됩니다.

기본키로 등록한다는 것은 테이블에 제약조건을 추가하는 것 입니다. 기본키로 등록된 필드는 null 값이여서는 안되기 때문입니다.

이런 제약조건을 확인하기 위해 추가적인 액션이 이루어 집니다. 삽입이나 삭제 작업 시 외래 키로 참조된 데이터를 항상 확인해야 하기 때문입니다. 따라서 식별관계는 비식별관계에 비해 성능적으로 떨어집니다.

하지만 기본키로 등록되어 null 값이 들어올 수 없게 DB 계층에서 제약조건을 통해 점검함으로써 정합성을 높일 수 있습니다. 기본키로 등록된 외래키가 null일 수 없으니 연관된 테이블에 해당 데이터가 꼭 있을 것을 강제할 수 있기 때문입니다.

따라서 성능과 데이터 무결성 간의 관계를 잘 비교해보며 선택을 해야 하는 것입니다. 여기에 더해 확장성도 고려해야 합니다.

식별관계는 앞서 말했듯 제약 조건이 추가됩니다. 따라서 복잡한 비즈니스 로직이 필요한 경우나 요구사항이 바뀌는 경우 해당 조건을 다 고려한 프로그래밍을 해야 합니다.

### 그래서 어떻게 결정했나요?

제가 만들고 있는 시스템은 초기 단계이고 구현중에도 개발 계획이 종종 변경되고 있습니다. 변경사항에 최대한 유연하게 반응할 수 있는 것이 중요합니다.

따라서 기본적으로는 비식별관계로 정의 하되 연관관계가 높아 한 쪽이 삭제되면 다른 쪽의 데이터 또한 삭제해야 하는 관계는 식별관계로 정의하기로 했습니다.

설문과 질문은 연관관계가 낮습니다. 질문은 다른 설문에도 활용할 수 있기 때문입니다. 이는 비식별관계로 정의합니다.

질문과 질문 선택지는 연관관계가 높습니다. 질문 선택지는 해당 질문에만 해당하는 내용으로 구성될 확률이 높기 때문입니다. 식별 관계로 정의하고 질문이 사라지면 연관 있는 질문 선택지가 같이 삭제 될 수 있도록 코드를 구성합니다.



## 다음으로

이번 포스트에는 abcdedu의 설문 기능을 개발하며 고민했던 점중 데이터의 식별/비식별 관계에 대한 내용을 얘기했습니다. 이후 포스트에서 DB 카디널리티와 JPA 매핑에 대한 얘기로 찾아 뵙겠습니다.



오늘도 글 읽어주셔서 감사합니다.

제안이나 수정 사항 있으면 언제든 말씀주세요. :-) 

